---
title: "Project_1"
author: "Sam Barbaro"
format: html
editor: visual
---

## Approach

I will import the text file from Github, use \| as a delimiter remove dashes, pivot wider so the two rows for each player are aligned, clean the data, and calculate the new number that references other opponents' ranks.

## Importing the data

```{r}
library(tidyverse)



new_data <- read.table("https://raw.githubusercontent.com/samanthabarbaro/data607/refs/heads/main/chess.txt", sep = "|", row.names = NULL, fill = TRUE)

#Can I drop blanks? (I tried this first wiht == "" and it didn't work)

filtered_new_data <- subset(new_data, V2 != "")
```

## Attempting to add labels and pivot wider

```{r}
#add labels and then pivot wider
#I will add a repeating row to the left side (e.g., 1, 2) and then use those to pivot the data wider

filtered_new_data <- filtered_new_data |>
    mutate(new_col = rep(c(1, 2), length.out = n())) 

```

## Breaking columns up and adding labels

```{r}


final_chess <- filtered_new_data |>
  mutate(person_id = rep(1:(n()/2), each = 2)) |>
  pivot_wider(
    id_cols = person_id,
    names_from = c(new_col),
    values_from = c(V1, V2, V3, V4, V5, V6, V7, V8, V9, V10)
  )

  
print(final_chess)
  
#let's clean up the names

more_final_chess <- final_chess |> select(player_id = V1_1, hometown = V1_2, player_name = V2_1, ranks = V2_2, total_pts = V3_1, first_opp = V4_1, second_opp = V5_1, third_opp = V6_1, fourth_opp = V7_1, fifth_opp = V8_1, sixth_opp = V9_1, seventh_opp = V10_1)


#parse out ranks 
#there are p + numbers on some ranks will need to go

separated_chess <- more_final_chess |>
    separate(col = ranks, into = c("USCF_ID", "scores"), sep = "/") |> separate(col = scores, into = c("pre_rank", "post_rank"), sep = "->") |> slice(-1)


#Let's delete some strings
#there were hidden spaces here and NAs weren't showing, so I used str_trim
del_chess <- separated_chess|>
  mutate((across(ends_with("_opp"), ~ str_sub(.x, start = 3))), pre_rank = str_sub(pre_rank, start = 4), across(everything(), ~ str_trim(.x) |> na_if("")))


#getting rid of everything after the p

chess_p <- del_chess |> 
    mutate(pre_rank = str_remove(pre_rank, "P.*")) |> 
    mutate(post_rank = str_remove(post_rank, "P.*"))

view(chess_p)

```

### Creating a reference for finding the opponent pre-tournament ranks

```{r}
#reference table
ref_tab <- chess_p |> select(player_id, opp_one_rnk = pre_rank)


ref <- ref_tab |> 
  mutate(id = player_id)


#attempting a join

ref <- chess_p |> 
    select(player_id, opp_one_rnk = pre_rank)


chess_final <- chess_p |>
    left_join(ref, by = c("first_opp" = "player_id"))


#let's try to join this all at once though 

ref <- chess_p |> 
  select(player_id, temp_rank = pre_rank)


opp_cols <- c("first_opp", "second_opp", "third_opp", "fourth_opp", 
              "fifth_opp", "sixth_opp", "seventh_opp")

# Join everything

#chess_final <- reduce(opp_cols, function(data, col_name) {
#    new_rank_name <- paste0(col_name, "_rnk")
    
#    data |>
#        left_join(rank_lookup, by = setNames("player_id", col_name)) |>
#        rename(!!new_rank_name := temp_rank)

#}, .init = chess_p)


#it occured to me that I could pivot longer, join just once and then just summarize (much easier)

chess_long <- chess_p |>
    pivot_longer(
        cols = c(first_opp, second_opp, third_opp, fourth_opp, fifth_opp, sixth_opp, seventh_opp),
        names_to = "round",
        values_to = "opponent_id"
    )

#*now* left join -- just once

chess_joined <- chess_long |>
    left_join(ref, by = c("opponent_id" = "player_id"))

chess_joined |> mutate(temp_rank = as.numeric(temp_rank))


#Arrange and get averages


chess_averages <- chess_joined |> 
    group_by(player_id, player_name, hometown, total_pts, pre_rank) |> mutate(temp_rank = as.numeric(temp_rank)) |>
    summarize(avg_opponent_rank = round(mean(temp_rank, na.rm = TRUE),0))

#organizing by rank and converting players' names to regular case:

very_final_chess <- chess_averages |> mutate(player_id = as.numeric(player_id)) |> arrange(player_id) |> mutate(player_name = str_to_title(player_name))

print(very_final_chess)

glimpse(very_final_chess)
```

### 
